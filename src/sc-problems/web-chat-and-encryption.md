---
title: Web アプリケーションのセキュリティ
description: "Web アプリケーションのセキュリティに関する次の記述を読み, それに関連する各問いに答えなさい。"
tags: ["Web", "HTML", "XSS", "情報通信", "権限設定"]
topic: Web/Encryption
date: 2024-08-08
difficulty: hard

problems:
  - id: "1-1"
    answer:
      type: select
      answer: XSS - クロスサイトスクリプティング
      choices:
        - XSS - クロスサイトスクリプティング
        - CSRF - クロスサイトリクエストフォージェリ
        - SQL インジェクション
        - クリックジャッキング
      explanation: |
        XSS は, Web アプリケーションにおいて, ユーザが入力したスクリプトを閲覧者のブラウザで実行させる脆弱性である。
        この脆弱性を悪用することで, ユーザの情報を盗み出すことが可能となる。
  - id: "1-2"
    answer:
      type: text
      answer: "閲覧者のローカルストレージに保存された認証情報を取得し, 自身のプロフィールにエンコードして送信する。"
      explanation: |
        `localStorage.getItem()` メソッドは, ローカルストレージに保存された値を取得するメソッドである。  
        fetch API と呼ばれる標準 API を用いてそれらを送信することで, 認証情報を漏洩させるスクリプトである。
      maxLength: 60
  - id: "1-3"
    answer:
      type: text
      answer: "スクリプトBによりGさんのプロフィール情報が上書きされ, あたかも情報の漏洩が無かったかのように見せかけられたから"
      explanation: |
        本文より, スクリプト B は漏洩の証拠を抹消するために, G さんのプロフィール情報を上書きするスクリプトであると推測される。
        本文中に, G さんが閲覧した直後にスクリプト B が送信されたとあるため, 上長が確認した G さんのプロフィール情報は,
        既にスクリプト B により書き換えられていた可能性がある。
      maxLength: 60
  - id: "1-4"
    answer:
      type: text
      answer: "G社一般公開グループの過去の会話から, Gさんのアイコンのパスを取得し, それに含まれるユーザIDを抽出した。"
      explanation: |
        本文より, 利用者 X と G さんは同じグループ（G 社一般公開グループ）に所属しており, やりとりをしたことがあると書いてある。
        また本文 の HTML より, 各メッセージには送信者のアイコンが表示され, そのパスにはユーザ ID が含まれている。
        利用者 X は, 過去の会話から G さんのアイコンのパスを取得し, それに含まれるユーザ ID を抽出した可能性がある。
      maxLength: 60
  - id: "2-1"
    answer:
      type: text
      answer: "エンコード認証されたトークンは検出対象に含まれないから"
      explanation: |
        本文より, サービス S はトークンの漏洩を検出するために, トークンをハッシュ化して検出対象に登録している。  
        ハッシュ化処理は不可逆的なもので, エンコードされたトークンは検出対象に含まれないため, このままでは検出できない。
      maxLength: 30
  - id: "2-2"
    answer:
      type: text
      answer: "海外のIPアドレスからのアクセスがあったため／同時にGさんから複数のアクセスがあったため"
      explanation: |
        本文より, D 社は日本の中小企業である。  
        当然 G さんも日本に在住しているため, 海外の IP アドレスからのアクセスが検出されることはありえない。  
        また, 同時に複数のアクセスをすることは画面遷移上困難であるため, このような状況が発生することはない。
      maxLength: 0
  - id: "2-3"
    answer:
      type: text
      answer: "内部犯罪／内部の者による犯罪／従業員による持ち出し"
      explanation: |
        本文より, 内部犯罪
      maxLength: 10
  - id: "2-4-1"
    answer:
      type: text
      answer: "利用者のIPアドレス／ユーザエージェント"
      explanation: |
        本文より, 異なる場所からのアクセスを一律にブロックすることは有効な対策である。  
        また, 異なるブラウザからのアクセスをユーザエージェントに基づいてブロックすることも有効な対策である。
      maxLength: 10
  - id: "2-4-2"
    answer:
      type: text
      answer: "利用者のIPアドレス／ユーザエージェント"
      explanation: |
        本文より, 異なる場所からのアクセスを一律にブロックすることは有効な対策である。
        また, 異なるブラウザからのアクセスをユーザエージェントに基づいてブロックすることも有効な対策である。
      maxLength: 10
---

# 問. Web アプリケーションのセキュリティに関する次の記述を読み, それに関連する各問いに答えなさい。

D 社は, Web アプリケーションを用いたチャットサービスを提供する日本の中小企業である。利用者は, ブラウザを用いてチャットサービス（以下, サービス Dという）にアクセスして,
他の利用者やりとりをする。他の利用者と一対一でチャットを行える機能（以下, ダイレクトメッセージ機能という）に加え,
複数の利用者でチャットを行える機能（以下, グループチャット機能という）も提供している。  
Web アプリケーションから送信されたメッセージ情報は D 社サーバに蓄積され, 送信者と受信者の間でやりとりされる。  
　サービス D は組織での利用も想定しており, 組織内の利用者同士でのみチャットを行える機能（以下, 組織内チャット機能という）を提供している。
組織内チャット機能においては, 組織によって管理された複数のグループが存在し, 利用者はそれぞれのグループ内でチャットを行える。
さらにセキュリティ対策の観点から, 指定したユーザのみが所属できるグループ（以下, 関係者グループという）を設定できるようにしている。
また, 組織内チャット機能においては, 公開グループと非公開グループの２種類のグループが存在し,
前者はサービス D に実装された一覧表示機能により不特定多数の利用者が参加可能であるが, 後者はそうではない。  
　また D 社内では, D サービスの組織内チャット機能を利用して, 他の従業員や部署とのコミュニケーションを行っている。
さらに利用者からの直接的なフィードバックを得るために, 公開グループ（以下, D 社公開グループという）を設けている。
D 社公開グループは, 全従業員および任意で参加した一般利用者が参加している。

さらに, サービス D の Web アプリケーションは専用の API を用いて D 社サーバと通信しており, チャット情報の送受信には HTTPS 通信を用いている。
以下に, サービス D の API エンドポイントの一部を示す。

- `/api/v1/orgs/{一意な組織 ID}/groups/{一意な組織内グループ ID}/messages?auth={認証トークン}`  
  組織内チャット機能において, 指定した組織とグループに所属する利用者のメッセージに関する情報を操作または取得する。  
  GET, PUT メソッドにより, それぞれメッセージ情報の取得, 送信が可能である。
- `/api/v1/users/{一意なユーザ ID}/profile?auth={認証トークン}`  
  指定した利用者のプロフィール情報を操作または取得する。
  GET, POST メソッドにより, それぞれプロフィール情報の取得, 更新が可能である。
  プロフィールの更新は, 更新される利用者自身のみが可能である。
- `/api/v1/users/{一意なユーザ ID}/icon.png?auth={認証トークン}`  
  指定した利用者のアイコン画像を操作または取得する。
  GET, PUT メソッドにより, それぞれアイコン画像の取得, 更新が可能である。
  取得時にのみ, 認証トークンを用いた**認証が不要**である。

また, D 社ではセキュリティ対策の一環として, 信頼できる外部サービス（以下, サービス S という）による認証トークン漏洩の監視を行っている。  
サービス S は, インターネット上での情報漏洩を監視し, 漏洩情報を D 社に通知するサービスである。D 社では, これに加えて,
利用者のプロフィールや送信されたメッセージも監視対象にし, 認証トークン漏洩の早期発見を目指している。  
　サービス D から発行された認証トークンは, すべてハッシュ化されてサービス S に送信され, 漏洩の検出対象に登録される。  
　サービス S からの通知を受けた D 社は, 自動的に通知情報を解析し, 漏洩した可能性のある認証トークンを失効させるなどの対応を行っている。

## 【脆弱性を悪用したセッション情報の持ち出し】

ある日, D 社公開グループの利用者から, 本文が空のメッセージが表示されているという報告が相次いでいることが判明した。
翌日, 開発部の G さんが報告のあったグループのチャット画面を自身のアカウントを用いて閲覧したところ, 利用者 X からのメッセージが表示されていた。
さらに, G さんがメッセージを表示して間もなく, 同じ送信者から新たなメッセージが送信され, いづれも本文が空であることが確認された。  
以下に G さんが取得したチャット画面のスクリーンショットを示す。

![図１](/images/sc-problems/web-chat-and-encryption/fig1.png)  
↑図１：利用者 X からのメッセージを含むグループチャット機能の画面

G さんは, これらのメッセージが利用者 X から送信されたものであることを確認したが, 本文が空であることに疑問を感じた。
そこで, G さんは当該画面の HTML を確認したところ, 次のようなコードが記述されていることを発見した。

```html
(省略)
<div class="message">
  <img src="/api/v1/users/○○○/icon.png" alt="利用者 A のプロフィール画像" />
  <span class="message-author">利用者 A</span>
  <span class="message-date">08/01/24 00:02</span>
  <span class="message-text">じゃけんラーメン屋いきましょうね～</span>
</div>
<div class="message">
  <img src="/api/v1/users/△△△/icon.png" alt="利用者 B のプロフィール画像" />
  <span class="message-author">利用者 B</span>
  <span class="message-date">08/01/24 00:03</span>
  <span class="message-text">いいですね！</span>
</div>
<div class="message">
  <img src="/api/v1/users/×××/icon.png" alt="利用者 X のプロフィール画像" />
  <span class="message-author">利用者 X</span>
  <span class="message-date">08/01/24 00:24</span>
  <span class="message-text">（スクリプト A）</span>
</div>
<div class="message">
  <img src="/api/v1/users/×××/icon.png" alt="利用者 X のプロフィール画像" />
  <span class="message-author">利用者 X</span>
  <span class="message-date">08/02/24 12:05</span>
  <span class="message-text">（スクリプト B）</span>
</div>
```

また, スクリプト A の内容を以下に示す。

```javascript
userId = "△△△"
// ローカルストレージに保存された認証トークンを取得
authToken = localStorage.getItem("authToken")

if (authToken) {
  fetch(`/api/v1/users/${userId}/profile`, {
    method: "POST",
    headers: {
      Authorization: `Bearer ${authToken}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      profile: {
        bio: `${encodeURIComponent(authToken)}`,
      },
    }),
  })
}
```

↑ 注記：コメントはスクリプトの説明のために追加されたものであり, 実際のスクリプトには含まれていない。  
　また, △△△は G さんのユーザ ID である。

G さんは, 利用者 X は `[    A    ]` と呼ばれる脆弱性を悪用するスクリプトを送信したものであると判断した。
利用者 X について調べると, 利用者 X は D 社公開グループに参加している一般利用者で, 過去に G さんとやりとりを行っていたことが判明した。  
　G さんは自身の認証トークンが漏洩している可能性があることを懸念し, その旨を上長に相談した。
上長は G さんのプロフィールを確認したうえで, 認証トークンが漏洩した事実は無く, スクリプト A は実際には機能しないものであると判断した。

開発部はこの潜在的な脆弱性に対処するために, メッセージの表示を行う際にスクリプトを無効化する操作を実装し, 対応を終了した。

## 【開発機密の漏洩】

ある日, D 社の開発部門の担当者である H さんが, インターネット上に D 社の開発機密が漏洩していることを確認した。
D 社は重大なインシデントが発生したと判断し, `[    B    ]` であることを考慮して, 社内規定に基いて各部門の長で構成された緊急対策本部を設置した。
緊急対策本部は, 漏洩した情報を確認し, 漏洩の原因を調査することにした。  
　表１に, 同日のサービス D の接続ログ（一部抜粋）を以下に示す。

| リクエスト時間 | IP アドレス     | リクエストした利用者 | リクエスト内容                            | レスポンス    |
| -------------- | --------------- | -------------------- | ----------------------------------------- | ------------- |
| 12:03:02       | aaa.bbb.ccc.xxx | 利用者 A             | GET `/api/v1/orgs/114/groups/13/messages` | 200 OK        |
| 12:03:16       | aaa.bbb.ccc.yyy | 利用者 B             | GET `/api/v1/orgs/810/groups/29/messages` | 200 OK        |
| 12:05:12       | aaa.bbb.ccc.yyy | 利用者 B             | GET `/api/v1/orgs/810/groups/64/messages` | 200 OK        |
| 12:05:12       | xxx.yyy.zzz.xxx | 利用者 X             | GET `/api/v1/users/○○○/profile`           | 200 OK        |
| 12:06:24       | aaa.bbb.abc.abc | G さん               | GET `/api/v1/orgs/1/groups/31/messages`   | 200 OK        |
| 12:06:24       | xxx.yyy.zzz.xxx | G さん               | GET `/api/v1/orgs/1/groups/1/messages`    | 200 OK        |
| 12:06:25       | xxx.yyy.zzz.xxx | G さん               | GET `/api/v1/orgs/1/groups/2/messages`    | 403 Forbidden |
| 12:06:26       | xxx.yyy.zzz.xxx | G さん               | GET `/api/v1/orgs/1/groups/3/messages`    | 403 Forbidden |
| 12:06:26       | aaa.bbb.ccc.yyy | 利用者 B             | GET `/api/v1/orgs/810/groups/53/messages` | 200 OK        |
| 12:06:27       | xxx.yyy.zzz.xxx | G さん               | GET `/api/v1/orgs/1/groups/4/messages`    | 200 OK        |
| 12:06:28       | xxx.yyy.zzz.xxx | G さん               | GET `/api/v1/orgs/1/groups/5/messages`    | 200 OK        |
| 12:06:30       | aaa.bbb.abc.abc | G さん               | GET `/api/v1/orgs/1/groups/13/messages`   | 200 OK        |
| 12:06:31       | aaa.bbb.ccc.yyy | 利用者 B             | GET `/api/v1/orgs/931/groups/52/messages` | 200 OK        |

↑ 表１：同日のサービス D の接続ログ（一部抜粋）  
　注記：`aaa.bbb.ccc`, `xxx.yyy.zzz` から始まる IP アドレスは, それぞれ国内のアドレス, 国外のアドレスを示す。

上記のログより, 緊急対策本部は G さんの認証トークンが漏洩していたと結論付け, 初動対応として G さんのトークンを含むすべてのトークンを失効させた。  
　さらに, セッションの管理方法を是正するため, 開発部に対して, ログインをした `[    C    ]` と, リクエストをした `[    C    ]` が異なる場合は,
そのリクエストを拒否して認証トークンを失効させるよう指示した。

この是正措置により, これ以上の情報漏洩を防げたことが確認され, 緊急対策本部は解散した。  
　D 社は, 現在運用されているサービス D のセキュリティを見直すことにした。

<!--problems-->

## 設問１【脆弱性を悪用したセッション情報の持ち出し】 について答えよ。

### （１）`[    A    ]` に該当する脆弱性の名称を答えなさい。

<!--problem-answer 1-1-->

### （２）スクリプト A の処理内容を具体的に６０字以内で説明しなさい。

<!--problem-answer 1-2-->

### （３）G さんの上長が認証トークンの漏洩は無いと判断した理由を, スクリプト B の内容を推察したうえで６０字以内で説明しなさい。

<!--problem-answer 1-3-->

### （４）どのようにして利用者 X は, G さんのユーザ ID を取得したか。具体的に, ６０字以内で説明しなさい。

ここで, ユーザ ID は推測困難なランダムな文字列で, 総当たり攻撃は非常に困難かつ不可能であるものとする。

<!--problem-answer 1-4-->

## 設問２ 【開発機密の漏洩】について答えよ。

### （１）G さんの認証トークンは実際には漏洩していたが, サービス S からの通知は無かった。この理由を３０字以内で説明しなさい。

<!--problem-answer 2-1-->

### （２）表１より, 緊急対策本部が G さんの認証トークンが漏洩していたと判断した理由を簡潔に述べなさい。

<!--problem-answer 2-2-->

### （３）何を考慮したために, ごく少数の限られた人員で緊急対策本部を設置したか。 `[    B    ]` に入る適切な内容を１０字以内で答えなさい。

<!--problem-answer 2-3-->

### （４）`[    C    ]` に該当する対策の内容を２つ, それぞれ１０字以内で述べなさい。

<!--problem-answer 2-4-1-->

<!--problem-answer 2-4-2-->
